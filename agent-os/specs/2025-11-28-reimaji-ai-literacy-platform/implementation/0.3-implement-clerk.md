# 0.3 Implement Clerk Authentication

## Ringkasan
- Integrasi Clerk untuk Next.js 16 (App Router): provider, halaman sign-in/up, proxy proteksi.
- Build, lint, type-check semua hijau dengan penanganan dynamic untuk layout & protected route.

Update verifikasi:
- Login nyata berhasil untuk `1200pixels@gmail.com`; halaman `/protected` menampilkan email dan role dari Convex (`role: pro`).
- Rute logout tersedia di `/sign-out` (hapus sesi lalu redirect ke `/sign-in`).
- Proxy diposisikan di `src/proxy.ts` sehingga Clerk tidak lagi error "clerkMiddleware() was not run".

## Tindakan
- Install: `npm install @clerk/nextjs`
- Env: tambah `NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY` dan `CLERK_SECRET_KEY` di `.env.local` (placeholder test), perlu diganti dengan key asli.
- Provider: bungkus `src/app/layout.tsx` dengan `ClerkProvider`; tandai layout sebagai dynamic.
- Halaman: `src/app/sign-in/[[...index]]/page.tsx` dan `src/app/sign-up/[[...index]]/page.tsx` dengan komponen Clerk.
- Proxy: `proxy.ts` pakai `clerkMiddleware` + `createRouteMatcher` untuk proteksi rute non-public.
- Protected sample: `src/app/protected/page.tsx` validasi server dengan `auth()` dan redirect ke `/sign-in`; tandai dynamic.
- Sign-out: tambahkan `src/app/sign-out/page.tsx` untuk mengakhiri sesi dan mengarahkan ulang ke `/sign-in`.

## Checklist
- [x] 0.3.1 Set up Clerk provider and configuration
- [x] 0.3.2 Configure sign-in/sign-up pages
- [x] 0.3.3 Implement proxy for route protection
- [x] 0.3.4 Tambahkan rute sign-out (logout) dan uji manual

## Verifikasi
- Type-check: sukses (`npm run type-check`, exit code 0)
- Lint: sukses (`npm run lint`, exit code 0)
- Build: sukses (`npm run build`, exit code 0); rute dynamic untuk menghindari error key saat prerender
- Rute:
  - `/sign-in`, `/sign-up` tersedia
  - `/protected` terproteksi, redirect ke `/sign-in` saat belum login
- Sinkronisasi: akses `/protected` akan upsert user Clerk → Convex (`users.upsertFromClerk`)
- Login UI: berhasil untuk `1200pixels@gmail.com` dengan hasil render `Email: 1200pixels@gmail.com` dan `Role: pro`.
- Logout: `GET /sign-out` menghasilkan 200 dan setelah aksi, user diarahkan ke `/sign-in`.

## Catatan
- Gunakan key asli dari Clerk dashboard untuk verifikasi login nyata.
 - Setelah key diisi, uji registrasi/login, pastikan proxy melindungi `/protected`, serta layout menampilkan state login.
 - Proxy harus berada di `src/proxy.ts` agar Next.js 16 menjalankan Clerk proxy pada Edge runtime.

Referensi: https://nextjs.org/docs/messages/middleware-to-proxy

### Rasional penggantian middleware → proxy
- “Middleware” sering diasosiasikan dengan Express.js sehingga mendorong misuse.
- Next.js mengarah ke API yang lebih ergonomis; middleware adalah last resort.
- “Proxy” menjelaskan posisi di boundary jaringan dan Edge Runtime default.

## Next
- Sinkronisasi user Clerk ke Convex (`users` table) saat sign-in (server actions/middleware)
- Implement halaman akun dasar dan user button di layout

## Cuplikan Implementasi Sign-out

```tsx
// src/app/sign-out/page.tsx
"use client"
import { useEffect } from 'react'
import { useRouter } from 'next/navigation'
import { useClerk } from '@clerk/nextjs'

export default function Page() {
  const router = useRouter()
  const { signOut } = useClerk()

  useEffect(() => {
    ;(async () => {
      await signOut()
      router.replace('/sign-in')
    })()
  }, [router, signOut])

  return <div className='p-8 text-sm'>Signing out...</div>
}
```
