# 3.5 Refinement: Security and Analytics

## Goal

Implement recommended improvements for security (defense in depth), query efficiency, and analytics coverage.

## Proposed Changes

### 1. Refactor `deleteAccount` (Security)

- **File**: `convex/users.ts`
- **Change**: Remove `clerkUserId` argument. Derive identity solely from `ctx.auth.getUserIdentity()`.
- **Update**: Update `src/app/(app)/profile/page.tsx` to call mutation without arguments.

### 2. Optimize User Queries (Performance/Privacy)

- **File**: `convex/users.ts`
- **Change**:
  - `listAll`: Use `q.eq(q.field('deletedAt'), undefined)` in Convex filter instead of JS filter.
  - `roleStats`: Use `q.eq(q.field('deletedAt'), undefined)` in Convex filter.

### 3. Complete Analytics Integration (Analytics)

- **LMS**:
  - **File**: `src/app/(app)/lms/[course]/[module]/[lesson]/page.tsx` (or component).
  - **Action**: Track `lesson_start` on mount. Track `lesson_complete` when "Next/Complete" button is clicked.
- **Dashboard**:
  - **File**: `src/app/(app)/dashboard/page.tsx`.
  - **Action**: Track `dashboard_view` (proxy for login/active user).
- **Subscription**:
  - **File**: Search for pricing/upgrade UI.
  - **Action**: Track `subscription_click` (intent).

## Verification Plan

- **Automated**: `npm run type-check`, `npm run lint`, `npm run build`.
- **Manual**:
  - Verify "Delete Account" still works.
  - Verify `user_actions` table populates when visiting Dashboard and Lessons.
