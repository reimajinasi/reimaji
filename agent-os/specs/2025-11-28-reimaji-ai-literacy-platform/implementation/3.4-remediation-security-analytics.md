# 3.4 Remediation: Security, Privacy, and Analytics

## Analysis of Review Findings

### 1. Critical Security Vulnerability (IDOR in `deleteAccount`)

- **Issue**: The `deleteAccount` mutation accepts `clerkUserId` and deletes the matching user without verifying if the authenticated caller _is_ that user.
- **Impact**: **Critical**. Any authenticated user can delete any other user's account if they guess the Clerk ID.
- **Root Cause**: Missing `ctx.auth.getUserIdentity()` check and comparison.

### 2. Incomplete Data Erasure (Soft Delete)

- **Issue**: `deleteAccount` sets `deletedAt`, but queries like `getByClerkId` do not filter out these users.
- **Impact**: **High**. "Deleted" accounts remain accessible and functional. Fails GDPR "Right to Erasure" compliance.
- **Root Cause**: Queries were not updated to exclude records where `deletedAt` is set.

### 3. Analytics "Dead Code"

- **Issue**: `useTrackAction` hook exists but is never imported or used.
- **Impact**: **High**. The KPI dashboard will remain empty. No data is being collected.
- **Root Cause**: Implementation stopped at "infrastructure" (hook creation) without "integration" (usage).

### 4. Inadequate Performance Monitoring

- **Issue**: `PerformanceMonitor` uses a custom `loadTime` metric instead of standard Web Vitals (LCP, CLS, INP).
- **Impact**: **Medium**. Metrics collected are not standard or comparable.
- **Root Cause**: Did not use Next.js `useReportWebVitals`.

## Remediation Plan

### Fix 1: Secure `deleteAccount` and Enforce Soft Delete

- **File**: `convex/users.ts`
- **Action**:
  - In `deleteAccount`: Get `identity`. Verify `identity.subject === args.clerkUserId`. Throw error if mismatch.
  - In `getByClerkId`, `listAll`, `roleStats`: Add `.filter(q => q.eq(q.field('deletedAt'), undefined))` (or check for null/missing).

### Fix 2: Integrate Analytics

- **Action**: Add `useTrackAction` to key interaction points.
- **Files**:
  - `src/app/(public)/news/[slug]/page.tsx`: Track `news_view`.
  - `src/components/features/lms/lesson-view.tsx` (or equivalent): Track `lesson_start`, `lesson_complete`.
  - `src/app/(auth)/sign-up/[[...index]]/page.tsx`: Track `signup` (if possible) or `src/app/(app)/dashboard/page.tsx` for first visit.

### Fix 3: Implement Web Vitals

- **File**: `src/components/performance-monitor.tsx`
- **Action**: Rewrite to use `useReportWebVitals`.
- **Backend**: Update `convex/analytics.ts` `trackPageView` (or create `trackWebVital`) to accept metric name, value, id, etc.

## Verification

- **Security**: Attempt to delete another user's account (should fail).
- **Privacy**: Delete own account -> Verify `getByClerkId` returns null.
- **Analytics**: Verify `user_actions` table populates after browsing.
- **Performance**: Verify `page_views` (or new table) contains LCP/CLS data.
