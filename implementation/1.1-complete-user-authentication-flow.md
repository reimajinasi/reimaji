# Task 1.1: Complete User Authentication Flow

## Status: ‚è≥ In Progress

## Overview
Implementasi alur autentikasi lengkap untuk platform Reimaji, termasuk registrasi, verifikasi email, dashboard pengguna, dan reset password.

---

## ‚úÖ Acceptance Criteria

### 1.1.1 User Registration with Email Verification
- [ ] Form registrasi dengan validasi email, password, dan nama lengkap
- [ ] Email verifikasi terkirim setelah registrasi berhasil
- [ ] Link verifikasi valid selama 24 jam
- [ ] User tidak bisa login sebelum email terverifikasi
- [ ] Error handling untuk email yang sudah terdaftar
- [ ] Password minimal 8 karakter dengan kombinasi huruf dan angka

### 1.1.2 User Dashboard with Profile Management
- [ ] Dashboard utama setelah login berhasil
- [ ] Halaman profil dengan form edit data diri
- [ ] Upload foto profil (maks 2MB, format JPG/PNG)
- [ ] Update informasi: nama, email, bio, pekerjaan
- [ ] Validasi email baru jika user mengganti email
- [ ] Log aktivitas user (login terakhir, perubahan profil)

### 1.1.3 Password Reset Functionality
- [ ] Form "Lupa Password" di halaman login
- [ ] Email reset password terkirim dalam 5 menit
- [ ] Link reset valid selama 1 jam
- [ ] Form reset password dengan konfirmasi password baru
- [ ] Password baru langsung aktif setelah reset
- [ ] Notifikasi email bahwa password telah diubah

---

## üìù Langkah Implementasi

### Fase 1: Setup Clerk Authentication
1. **Konfigurasi Clerk**
   ```bash
   # Install dependencies
   npm install @clerk/nextjs
   
   # Setup environment variables
   NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_...
   CLERK_SECRET_KEY=sk_test_...
   NEXT_PUBLIC_CLERK_SIGN_IN_URL=/sign-in
   NEXT_PUBLIC_CLERK_SIGN_UP_URL=/sign-up
   NEXT_PUBLIC_CLERK_AFTER_SIGN_IN_URL=/dashboard
   NEXT_PUBLIC_CLERK_AFTER_SIGN_UP_URL=/email-verification
   ```

2. **Middleware Configuration**
   ```typescript
   // middleware.ts
   import { authMiddleware } from "@clerk/nextjs";
   
   export default authMiddleware({
     publicRoutes: ["/", "/news", "/research", "/sign-in", "/sign-up"],
     ignoredRoutes: ["/api/webhooks/clerk"]
   });
   ```

### Fase 2: Registration Flow
1. **Custom Sign Up Page**
   ```typescript
   // app/(public)/sign-up/page.tsx
   import { SignUp } from "@clerk/nextjs";
   
   export default function SignUpPage() {
     return (
       <div className="container mx-auto max-w-md py-8">
         <SignUp 
           routing="path"
           path="/sign-up"
           afterSignUpUrl="/email-verification"
         />
       </div>
     );
   }
   ```

2. **Email Verification Page**
   ```typescript
   // app/(public)/email-verification/page.tsx
   import { useClerk } from "@clerk/nextjs";
   
   export default function EmailVerification() {
     const { user } = useClerk();
     
     return (
       <div className="container mx-auto max-w-md py-8">
         <Card>
           <CardHeader>
             <CardTitle>Verifikasi Email</CardTitle>
             <CardDescription>
               Kami telah mengirim email verifikasi ke {user?.primaryEmailAddress?.emailAddress}
             </CardDescription>
           </CardHeader>
           <CardContent>
             <Button onClick={() => user?.primaryEmailAddress?.sendVerification()}>
               Kirim Ulang Email
             </Button>
           </CardContent>
         </Card>
       </div>
     );
   }
   ```

### Fase 3: User Dashboard
1. **Dashboard Layout**
   ```typescript
   // app/(app)/dashboard/layout.tsx
   import { DashboardNav } from "@/components/layout/dashboard-nav";
   
   export default function DashboardLayout({
     children,
   }: {
     children: React.ReactNode;
   }) {
     return (
       <div className="flex h-screen">
         <DashboardNav />
         <main className="flex-1 overflow-y-auto">
           {children}
         </main>
       </div>
     );
   }
   ```

2. **Profile Management**
   ```typescript
   // app/(app)/profile/page.tsx
   import { useUser, useClerk } from "@clerk/nextjs";
   import { useForm } from "react-hook-form";
   import { zodResolver } from "@hookform/resolvers/zod";
   import * as z from "zod";
   
   const profileSchema = z.object({
     firstName: z.string().min(2, "Nama depan minimal 2 karakter"),
     lastName: z.string().min(2, "Nama belakang minimal 2 karakter"),
     bio: z.string().max(500, "Bio maksimal 500 karakter").optional(),
     jobTitle: z.string().optional(),
   });
   
   export default function ProfilePage() {
     const { user } = useUser();
     const { setUser } = useClerk();
     
     const form = useForm<z.infer<typeof profileSchema>>({
       resolver: zodResolver(profileSchema),
       defaultValues: {
         firstName: user?.firstName || "",
         lastName: user?.lastName || "",
         bio: user?.unsafeMetadata?.bio as string || "",
         jobTitle: user?.unsafeMetadata?.jobTitle as string || "",
       },
     });
     
     const onSubmit = async (data: z.infer<typeof profileSchema>) => {
       try {
         await user?.update({
           firstName: data.firstName,
           lastName: data.lastName,
           unsafeMetadata: {
             ...user.unsafeMetadata,
             bio: data.bio,
             jobTitle: data.jobTitle,
           },
         });
       } catch (error) {
         console.error("Error updating profile:", error);
       }
     };
     
     return (
       <div className="container mx-auto max-w-2xl py-8">
         <Form {...form}>
           <form onSubmit={form.handleSubmit(onSubmit)}>
             {/* Form fields */}
             <Button type="submit">Simpan Perubahan</Button>
           </form>
         </Form>
       </div>
     );
   }
   ```

### Fase 4: Password Reset
1. **Forgot Password Page**
   ```typescript
   // app/(public)/forgot-password/page.tsx
   import { useState } from "react";
   import { useClerk } from "@clerk/nextjs";
   
   export default function ForgotPasswordPage() {
     const [email, setEmail] = useState("");
     const [isSubmitted, setIsSubmitted] = useState(false);
     const { client } = useClerk();
     
     const handleSubmit = async (e: React.FormEvent) => {
       e.preventDefault();
       try {
         await client?.signIn.create({
           strategy: "reset_password_email_code",
           identifier: email,
         });
         setIsSubmitted(true);
       } catch (error) {
         console.error("Error sending reset email:", error);
       }
     };
     
     if (isSubmitted) {
       return (
         <div className="container mx-auto max-w-md py-8">
           <Card>
             <CardHeader>
               <CardTitle>Email Terkirim</CardTitle>
               <CardDescription>
                 Kami telah mengirim link reset password ke {email}
               </CardDescription>
             </CardHeader>
           </Card>
         </div>
       );
     }
     
     return (
       <div className="container mx-auto max-w-md py-8">
         <form onSubmit={handleSubmit}>
           <Input
             type="email"
             placeholder="Masukkan email Anda"
             value={email}
             onChange={(e) => setEmail(e.target.value)}
             required
           />
           <Button type="submit">Kirim Link Reset</Button>
         </form>
       </div>
     );
   }
   ```

---

## üîç Verifikasi & Testing

### Unit Testing
```typescript
// __tests__/auth/registration.test.ts
import { render, screen, fireEvent, waitFor } from "@testing-library/react";
import SignUpPage from "@/app/(public)/sign-up/page";

describe("User Registration", () => {
  it("should show validation errors for invalid email", async () => {
    render(<SignUpPage />);
    
    const emailInput = screen.getByPlaceholderText("Email address");
    fireEvent.change(emailInput, { target: { value: "invalid-email" } });
    fireEvent.blur(emailInput);
    
    await waitFor(() => {
      expect(screen.getByText("Please enter a valid email address")).toBeInTheDocument();
    });
  });
  
  it("should show password requirements", async () => {
    render(<SignUpPage />);
    
    const passwordInput = screen.getByPlaceholderText("Password");
    fireEvent.change(passwordInput, { target: { value: "123" } });
    fireEvent.blur(passwordInput);
    
    await waitFor(() => {
      expect(screen.getByText("Password must be at least 8 characters long")).toBeInTheDocument();
    });
  });
});
```

### Integration Testing
```typescript
// __tests__/auth/dashboard.test.ts
import { render, screen } from "@testing-library/react";
import { useUser } from "@clerk/nextjs";
import ProfilePage from "@/app/(app)/profile/page";

jest.mock("@clerk/nextjs");

describe("User Dashboard", () => {
  it("should display user profile information", () => {
    const mockUser = {
      firstName: "John",
      lastName: "Doe",
      emailAddresses: [{ emailAddress: "john@example.com" }],
      unsafeMetadata: { bio: "Software Developer" },
    };
    
    (useUser as jest.Mock).mockReturnValue({ user: mockUser });
    
    render(<ProfilePage />);
    
    expect(screen.getByDisplayValue("John")).toBeInTheDocument();
    expect(screen.getByDisplayValue("Doe")).toBeInTheDocument();
    expect(screen.getByDisplayValue("Software Developer")).toBeInTheDocument();
  });
});
```

### E2E Testing
```typescript
// playwright/auth.spec.ts
import { test, expect } from "@playwright/test";

test.describe("Authentication Flow", () => {
  test("complete registration and verification flow", async ({ page }) => {
    // Navigate to sign up
    await page.goto("/sign-up");
    
    // Fill registration form
    await page.fill('input[name="emailAddress"]', "test@example.com");
    await page.fill('input[name="password"]', "Test123456");
    await page.fill('input[name="firstName"]', "Test");
    await page.fill('input[name="lastName"]', "User");
    
    // Submit form
    await page.click('button[type="submit"]');
    
    // Should redirect to email verification
    await expect(page).toHaveURL("/email-verification");
    await expect(page.locator("text=Verifikasi Email")).toBeVisible();
  });
  
  test("password reset flow", async ({ page }) => {
    await page.goto("/sign-in");
    
    // Click forgot password
    await page.click('a[href="/forgot-password"]');
    await expect(page).toHaveURL("/forgot-password");
    
    // Enter email
    await page.fill('input[type="email"]', "test@example.com");
    await page.click('button[type="submit"]');
    
    // Should show success message
    await expect(page.locator("text=Email Terkirim")).toBeVisible();
  });
});
```

---

## ‚ö†Ô∏è Risiko & Mitigasi

### Risiko Utama
1. **Email Delivery Failure**
   - **Dampak**: User tidak bisa verifikasi akun
   - **Mitigasi**: Gunakan email service yang reliable (Resend), tambahkan fallback ke WhatsApp/SMS
   - **Monitoring**: Track email delivery rates, setup alerting untuk failure rate >5%

2. **Security Vulnerabilities**
   - **Dampak**: Akun user bisa diretas
   - **Mitigasi**: Implement rate limiting, CAPTCHA untuk percobaan login berulang, 2FA untuk Pro users
   - **Monitoring**: Security audit tiap 3 bulan, penetration testing

3. **Performance Issues**
   - **Dampak**: User experience buruk, bounce rate tinggi
   - **Mitigasi**: Implement proper caching, optimize images, lazy loading untuk dashboard
   - **Monitoring**: Page load time <3 detik, Core Web Vitals monitoring

4. **Data Synchronization**
   - **Dampak**: Data user tidak konsisten antara Clerk dan Convex
   - **Mitigasi**: Implement webhook handlers untuk Clerk events, regular data reconciliation
   - **Monitoring**: Setup alerts untuk data mismatch, audit log untuk semua perubahan

---

## üìã Checklist Pengerjaan

### Hari 1-2: Setup Clerk & Basic Auth
- [ ] Install Clerk dependencies
- [ ] Configure middleware dan environment variables
- [ ] Create sign-in and sign-up pages
- [ ] Test basic authentication flow

### Hari 3-4: Registration & Verification
- [ ] Customize registration form
- [ ] Implement email verification page
- [ ] Setup email templates
- [ ] Test verification flow end-to-end

### Hari 5-6: User Dashboard
- [ ] Create dashboard layout and navigation
- [ ] Implement profile management page
- [ ] Add profile picture upload functionality
- [ ] Test profile update flow

### Hari 7-8: Password Reset
- [ ] Create forgot password page
- [ ] Implement password reset flow
- [ ] Setup reset email templates
- [ ] Test password reset functionality

### Hari 9-10: Testing & Optimization
- [ ] Write unit tests for auth components
- [ ] Create integration tests for user flows
- [ ] Perform E2E testing
- [ ] Optimize performance and fix bugs

---

## üîó Dependencies

### External Services
- **Clerk**: Authentication provider
- **Resend**: Email delivery service
- **Convex**: User data storage

### Internal Dependencies
- Design system components dari `/knowledge-base/design-system/`
- UI components dari `components/ui/`
- Utility functions dari `lib/utils/`

---

## üìä Success Metrics

- **Conversion Rate**: Target 70% email verification completion
- **User Onboarding**: Target <5 menit dari registrasi ke dashboard
- **Password Reset**: Target 90% success rate untuk reset requests
- **User Satisfaction**: Target NPS >50 untuk auth